{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-4xl font-bold text-gray-800"><i class="fas fa-calendar-alt text-purple-600 mr-2"></i>Horarios</h1>
    </div>
    
    {% for grade_id, data in schedules_by_grade.items() %}
    <div class="space-y-4">
        <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-4 rounded-lg flex justify-between items-center">
            <h2 class="text-2xl font-bold">{{ data.grade.name }}</h2>
            {% if current_user.role == 'admin' %}
            <button onclick="openModal('addScheduleModal')" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-gray-100 transition">
                <i class="fas fa-plus"></i> Agregar
            </button>
            {% endif %}
        </div>
        
        {% if data.schedules %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-purple-600 to-purple-700 text-white">
                    <tr>
                        <th class="px-6 py-4 text-left">Día</th>
                        <th class="px-6 py-4 text-left">Profesor</th>
                        <th class="px-6 py-4 text-left">Hora Inicio</th>
                        <th class="px-6 py-4 text-left">Hora Fin</th>
                        <th class="px-6 py-4 text-left">Aula</th>
                        {% if current_user.role == 'admin' %}
                        <th class="px-6 py-4 text-left">Acciones</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for schedule in data.schedules %}
                    <tr class="hover:bg-sky-50">
                        <td class="px-6 py-4 text-sm">
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">{{ schedule.day_of_week }}</span>
                        </td>
                        <td class="px-6 py-4 text-sm font-semibold">{{ schedule.course.teacher.user.name }}</td>
                        <td class="px-6 py-4 text-sm">{{ schedule.start_time }}</td>
                        <td class="px-6 py-4 text-sm">{{ schedule.end_time }}</td>
                        <td class="px-6 py-4 text-sm">{{ schedule.classroom or '-' }}</td>
                        {% if current_user.role == 'admin' %}
                        <td class="px-6 py-4 flex gap-2">
                            <a href="{{ url_for('edit_schedule', schedule_id=schedule.id) }}" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold transition">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <form method="POST" action="{{ url_for('delete_schedule', schedule_id=schedule.id) }}" style="display:inline;">
                                <button type="submit" onclick="return confirm('¿Eliminar horario?')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-bold transition">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </form>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded">
            <p class="text-sm">No hay horarios registrados para este grado.</p>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

{% if current_user.role == 'admin' %}
<div id="addScheduleModal" style="display:none" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md border-t-4 border-purple-500 shadow-2xl max-h-96 overflow-y-auto">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Agregar Horario</h2>
        <form method="POST" action="{{ url_for('add_schedule') }}" class="space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Día</label>
                <select name="day_of_week" required class="w-full px-4 py-3 bg-sky-50 border-2 border-sky-200 rounded-lg focus:outline-none focus:border-sky-500 text-gray-800">
                    <option value="">Selecciona un día</option>
                    <option value="Lunes">Lunes</option>
                    <option value="Martes">Martes</option>
                    <option value="Miércoles">Miércoles</option>
                    <option value="Jueves">Jueves</option>
                    <option value="Viernes">Viernes</option>
                    <option value="Sábado">Sábado</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Materia</label>
                <select id="subjectSelect" name="subject_id" required onchange="showTeacherSpecializations()" class="w-full px-4 py-3 bg-sky-50 border-2 border-sky-200 rounded-lg focus:outline-none focus:border-sky-500 text-gray-800">
                    <option value="">Selecciona una materia</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="specializationInfo" style="display:none;" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3 rounded">
                <p class="text-sm font-semibold mb-2">Especialidades de profesores:</p>
                <div id="specializationList" class="text-sm space-y-1"></div>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Profesor</label>
                <select name="teacher_id" required class="w-full px-4 py-3 bg-sky-50 border-2 border-sky-200 rounded-lg focus:outline-none focus:border-sky-500 text-gray-800">
                    <option value="">Selecciona un profesor</option>
                    {% for teacher in teachers %}
                    <option value="{{ teacher.id }}">
                        {{ teacher.user.name }} - {{ teacher.specialization or 'Sin especialización' }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Hora Inicio</label>
                <input type="time" name="start_time" required class="w-full px-4 py-3 bg-sky-50 border-2 border-sky-200 rounded-lg focus:outline-none focus:border-sky-500 text-gray-800">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Hora Fin</label>
                <input type="time" name="end_time" required class="w-full px-4 py-3 bg-sky-50 border-2 border-sky-200 rounded-lg focus:outline-none focus:border-sky-500 text-gray-800">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Aula</label>
                <input type="text" name="classroom" placeholder="Ej: A101" class="w-full px-4 py-3 bg-sky-50 border-2 border-sky-200 rounded-lg focus:outline-none focus:border-sky-500 text-gray-800">
            </div>
            <div class="flex gap-3 pt-4">
                <button type="submit" class="flex-1 gradient-btn text-white py-3 rounded-lg transition font-bold">Guardar</button>
                <button type="button" onclick="closeModal('addScheduleModal')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded-lg transition font-bold">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
const teacherSpecializationMap = {
    {% for subject_id, teachers_list in subject_teachers_map.items() %}
    "{{ subject_id }}": [
        {% for teacher in teachers_list %}
        { name: "{{ teacher.name }}", specialization: "{{ teacher.specialization }}" },
        {% endfor %}
    ],
    {% endfor %}
};

function openModal(id) { 
    document.getElementById(id).style.display = 'flex';
}

function closeModal(id) { 
    document.getElementById(id).style.display = 'none'; 
}

function showTeacherSpecializations() {
    const subjectSelect = document.getElementById('subjectSelect');
    const specializationInfo = document.getElementById('specializationInfo');
    const specializationList = document.getElementById('specializationList');
    
    const selectedSubject = subjectSelect.value;
    
    if (!selectedSubject) {
        specializationInfo.style.display = 'none';
        return;
    }
    
    const teachers = teacherSpecializationMap[selectedSubject] || [];
    
    if (teachers.length === 0) {
        specializationInfo.style.display = 'none';
        return;
    }
    
    specializationInfo.style.display = 'block';
    specializationList.innerHTML = '';
    
    teachers.forEach(teacher => {
        const div = document.createElement('div');
        div.textContent = `• ${teacher.name} - ${teacher.specialization}`;
        specializationList.appendChild(div);
    });
}
</script>
{% endif %}
{% endblock %}
