{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-4xl font-bold text-gray-800"><i class="fas fa-star text-blue-600 mr-2"></i>Registrar Calificaciones</h1>
        <div class="w-80">
            <input type="text" placeholder="üîç B√∫squeda general de estudiantes..." id="global-search" class="w-full px-4 py-3 rounded-lg border-2 border-blue-300 text-gray-800 text-sm focus:outline-none focus:border-blue-600 shadow-sm">
        </div>
    </div>
    
    {% if grades_data %}
        {% for grade_id, data in grades_data.items() %}
        <div class="space-y-4">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-lg flex justify-between items-center">
                <h2 class="text-2xl font-bold">{{ data.grade.name }}</h2>
                <div class="flex gap-2">
                    <button type="button" class="add-student-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-bold" data-grade-id="{{ grade_id }}">
                        <i class="fas fa-plus"></i> Agregar Estudiante
                    </button>
                    <button type="button" class="add-new-student-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold" data-grade-id="{{ grade_id }}">
                        <i class="fas fa-user-plus"></i> Crear Estudiante
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden modal-add-student-{{ grade_id }} hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
                <div class="bg-white rounded-lg p-6 w-96 shadow-2xl max-h-96 overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">Agregar Estudiante a {{ data.grade.name }}</h3>
                    <form method="POST">
                        <input type="hidden" name="action" value="add_student">
                        <input type="hidden" name="grade_id" value="{{ grade_id }}">
                        <div class="mb-3">
                            <label class="block text-sm font-semibold mb-1">Estudiante</label>
                            <select name="student_id" class="w-full px-3 py-2 border-2 border-blue-300 rounded text-sm" required>
                                <option value="">Selecciona un estudiante...</option>
                                {% for grade in all_grades %}
                                    {% if grade.id == grade_id %}
                                        {% for student in grade.students %}
                                            {% if not student.enrollments or not student.enrollments|selectattr('teacher_id', 'equalto', current_user.teacher_profile.id if current_user.role == 'teacher' else None)|list %}
                                            <option value="{{ student.id }}">{{ student.apellido_paterno }} {{ student.apellido_materno }} {{ student.user.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-semibold mb-1">Materia</label>
                            <select name="subject_id" class="w-full px-3 py-2 border-2 border-blue-300 rounded text-sm" required>
                                <option value="">Selecciona una materia...</option>
                                {% for subject in all_subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-bold text-sm">
                                <i class="fas fa-check"></i> Agregar
                            </button>
                            <button type="button" class="flex-1 close-modal-{{ grade_id }} bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold text-sm">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Modal para crear nuevo estudiante con calificaciones -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden modal-create-student-{{ grade_id }} hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
                <div class="bg-white rounded-lg p-6 w-96 shadow-2xl max-h-96 overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">Crear Estudiante con Calificaciones</h3>
                    <form method="POST">
                        <input type="hidden" name="action" value="create_student_with_grades">
                        <input type="hidden" name="grade_id" value="{{ grade_id }}">
                        <div class="mb-2">
                            <label class="block text-xs font-semibold mb-1">Nombre</label>
                            <input type="text" name="name" class="w-full px-2 py-1 border-2 border-blue-300 rounded text-xs" required>
                        </div>
                        <div class="mb-2">
                            <label class="block text-xs font-semibold mb-1">Apellido Paterno</label>
                            <input type="text" name="apellido_paterno" class="w-full px-2 py-1 border-2 border-blue-300 rounded text-xs" required>
                        </div>
                        <div class="mb-2">
                            <label class="block text-xs font-semibold mb-1">Apellido Materno</label>
                            <input type="text" name="apellido_materno" class="w-full px-2 py-1 border-2 border-blue-300 rounded text-xs" required>
                        </div>
                        <div class="mb-2">
                            <label class="block text-xs font-semibold mb-1">Materia</label>
                            <select name="subject_id" class="w-full px-2 py-1 border-2 border-blue-300 rounded text-xs" required>
                                <option value="">Selecciona...</option>
                                {% for subject in all_subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="block text-xs font-semibold mb-1">1er Semestre</label>
                            <input type="number" name="semester_1" min="0" max="100" step="0.5" class="w-full px-2 py-1 border-2 border-blue-300 rounded text-xs">
                        </div>
                        <div class="mb-2">
                            <label class="block text-xs font-semibold mb-1">2do Semestre</label>
                            <input type="number" name="semester_2" min="0" max="100" step="0.5" class="w-full px-2 py-1 border-2 border-blue-300 rounded text-xs">
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-semibold mb-1">3er Semestre</label>
                            <input type="number" name="semester_3" min="0" max="100" step="0.5" class="w-full px-2 py-1 border-2 border-blue-300 rounded text-xs">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded font-bold text-sm">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button type="button" class="flex-1 close-create-modal-{{ grade_id }} bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded font-bold text-sm">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left">Estudiante</th>
                            <th class="px-6 py-4 text-left">Grado</th>
                            <th class="px-6 py-4 text-center">1er Semestre</th>
                            <th class="px-6 py-4 text-center">2do Semestre</th>
                            <th class="px-6 py-4 text-center">3er Semestre</th>
                            <th class="px-6 py-4 text-center">Promedio</th>
                            <th class="px-6 py-4 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y search-body-{{ grade_id }}">
                        {% for item in data.students_with_scores %}
                        <tr class="hover:bg-sky-50 {% if not item.has_enrollment %}bg-gray-50{% endif %} student-row" data-student-name="{{ item.student.apellido_paterno or '' }} {{ item.student.apellido_materno or '' }} {{ item.student.user.name }}">
                            <td class="px-6 py-4 font-semibold">{{ item.student.apellido_paterno or '' }} {{ item.student.apellido_materno or '' }} {{ item.student.user.name }}</td>
                            <td class="px-6 py-4 text-sm">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">{{ item.student.grade.name }}</span>
                            </td>
                            {% if item.has_enrollment %}
                            <form method="POST" class="contents" id="form-{{ item.enrollment.id }}">
                                <input type="hidden" name="action" value="update_grades">
                                <input type="hidden" name="enrollment_id" value="{{ item.enrollment.id }}">
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_1" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_1 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center edit-mode-{{ item.enrollment.id }}" data-enrollment-id="{{ item.enrollment.id }}" disabled>
                                </td>
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_2" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_2 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center edit-mode-{{ item.enrollment.id }}" data-enrollment-id="{{ item.enrollment.id }}" disabled>
                                </td>
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_3" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_3 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center edit-mode-{{ item.enrollment.id }}" data-enrollment-id="{{ item.enrollment.id }}" disabled>
                                </td>
                                <td class="px-6 py-4 text-center font-bold text-lg">
                                    <span class="promedio-valor text-2xl" id="promedio-{{ item.enrollment.id }}">
                                        {% if item.total_score > 0 %}
                                            <span class="{% if item.total_score >= 60 %}text-green-600{% else %}text-red-600{% endif %}">{{ item.total_score }}</span>
                                        {% else %}
                                            <span class="text-gray-400">-</span>
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <div class="flex gap-2 justify-center">
                                        <button type="button" class="toggle-edit-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold" data-enrollment-id="{{ item.enrollment.id }}">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                        <form method="POST" style="display:inline;" onsubmit="return confirm('¬øEliminar este estudiante?')">
                                            <input type="hidden" name="action" value="delete_enrollment">
                                            <input type="hidden" name="enrollment_id" value="{{ item.enrollment.id }}">
                                            <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs font-bold">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </form>
                            {% else %}
                            <td colspan="7" class="px-6 py-4">
                                <span class="text-gray-400 text-sm italic">No inscrito contigo</span>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded">
        <p class="font-semibold">No hay cursos asignados</p>
        <p class="text-sm">Solicita al administrador que te asigne cursos para registrar calificaciones.</p>
    </div>
    {% endif %}
</div>

<script>
// B√∫squeda general
const globalSearch = document.getElementById('global-search');
globalSearch.addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const allRows = document.querySelectorAll('.student-row');
    
    allRows.forEach(row => {
        const studentName = row.getAttribute('data-student-name').toLowerCase();
        if (studentName.includes(searchTerm) || searchTerm === '') {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Toggle edit mode
document.querySelectorAll('.toggle-edit-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const enrollmentId = this.getAttribute('data-enrollment-id');
        const inputs = document.querySelectorAll('.edit-mode-' + enrollmentId);
        const isDisabled = inputs[0].disabled;
        
        inputs.forEach(input => {
            input.disabled = !isDisabled;
            if (!isDisabled) {
                input.classList.add('border-yellow-500', 'border-4', 'bg-yellow-50');
            } else {
                input.classList.remove('border-yellow-500', 'border-4', 'bg-yellow-50');
            }
        });
        
        // Cambiar texto del bot√≥n
        if (isDisabled) {
            this.innerHTML = '<i class="fas fa-save"></i> Guardar';
            this.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            this.classList.add('bg-green-500', 'hover:bg-green-600');
        } else {
            this.innerHTML = '<i class="fas fa-edit"></i> Modificar';
            this.classList.remove('bg-green-500', 'hover:bg-green-600');
            this.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }
    });
});

// Modal de agregar estudiante existente
document.querySelectorAll('.add-student-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const gradeId = this.getAttribute('data-grade-id');
        const modal = document.querySelector('.modal-add-student-' + gradeId);
        modal.style.display = 'flex';
    });
});

document.querySelectorAll('[class*="close-modal-"]').forEach(btn => {
    btn.addEventListener('click', function() {
        const classList = this.className.match(/close-modal-[\w-]+/)[0];
        const gradeId = classList.replace('close-modal-', '');
        const modal = document.querySelector('.modal-add-student-' + gradeId);
        modal.style.display = 'none';
    });
});

// Modal de crear nuevo estudiante
document.querySelectorAll('.add-new-student-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const gradeId = this.getAttribute('data-grade-id');
        const modal = document.querySelector('.modal-create-student-' + gradeId);
        modal.style.display = 'flex';
    });
});

document.querySelectorAll('[class*="close-create-modal-"]').forEach(btn => {
    btn.addEventListener('click', function() {
        const classList = this.className.match(/close-create-modal-[\w-]+/)[0];
        const gradeId = classList.replace('close-create-modal-', '');
        const modal = document.querySelector('.modal-create-student-' + gradeId);
        modal.style.display = 'none';
    });
});

// Auto-save on semester change
document.querySelectorAll('.semester-input').forEach(input => {
    input.addEventListener('change', function() {
        const enrollmentId = this.getAttribute('data-enrollment-id');
        const form = document.getElementById('form-' + enrollmentId);
        
        if (form) {
            const sem1Input = form.querySelector('input[name="semester_1"]');
            const sem2Input = form.querySelector('input[name="semester_2"]');
            const sem3Input = form.querySelector('input[name="semester_3"]');
            
            const sem1 = sem1Input ? (parseFloat(sem1Input.value) || 0) : 0;
            const sem2 = sem2Input ? (parseFloat(sem2Input.value) || 0) : 0;
            const sem3 = sem3Input ? (parseFloat(sem3Input.value) || 0) : 0;
            
            // Calcular promedio: (semestre1 + semestre2 + semestre3) / 3
            const promedio = (sem1 + sem2 + sem3) / 3;
            const promedioRedondeado = Math.round(promedio * 100) / 100;
            
            // Mostrar promedio
            const promediElement = document.getElementById('promedio-' + enrollmentId);
            if (promediElement) {
                const colorClass = promedioRedondeado >= 60 ? 'text-green-600' : 'text-red-600';
                promediElement.innerHTML = `<span class="${colorClass}">${promedioRedondeado.toFixed(2)}</span>`;
            }
            
            // Guardar autom√°ticamente
            const formData = new FormData(form);
            fetch('{{ url_for("teacher_grades") }}', {
                method: 'POST',
                body: formData
            }).catch(error => console.error('Error al guardar:', error));
        }
    });
});
</script>
{% endblock %}
