{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-4xl font-bold text-gray-800"><i class="fas fa-star text-blue-600 mr-2"></i>Registrar Calificaciones</h1>
        <div class="w-80">
            <input type="text" placeholder="üîç B√∫squeda general de estudiantes..." id="global-search" class="w-full px-4 py-3 rounded-lg border-2 border-blue-300 text-gray-800 text-sm focus:outline-none focus:border-blue-600 shadow-sm">
        </div>
    </div>
    
    {% if grades_data %}
        {% for grade_id, data in grades_data.items() %}
        <div class="space-y-4">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-lg flex justify-between items-center">
                <h2 class="text-2xl font-bold">{{ data.grade.name }}</h2>
                <div class="w-64">
                    <input type="text" placeholder="üîç Buscar estudiante..." class="search-input w-full px-4 py-2 rounded bg-white text-gray-800 text-sm" data-grade-id="{{ grade_id }}">
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left">Estudiante</th>
                            <th class="px-6 py-4 text-left">Grado</th>
                            <th class="px-6 py-4 text-center">1er Semestre</th>
                            <th class="px-6 py-4 text-center">2do Semestre</th>
                            <th class="px-6 py-4 text-center">3er Semestre</th>
                            <th class="px-6 py-4 text-center">Promedio</th>
                            <th class="px-6 py-4 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y search-body-{{ grade_id }}">
                        {% for item in data.students_with_scores %}
                        <tr class="hover:bg-sky-50 {% if not item.has_enrollment %}bg-gray-50{% endif %} student-row" data-student-name="{{ item.student.apellido_paterno or '' }} {{ item.student.apellido_materno or '' }} {{ item.student.user.name }}">
                            <td class="px-6 py-4 font-semibold">{{ item.student.apellido_paterno or '' }} {{ item.student.apellido_materno or '' }} {{ item.student.user.name }}</td>
                            <td class="px-6 py-4 text-sm">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">{{ item.student.grade.name }}</span>
                            </td>
                            {% if item.has_enrollment %}
                            <form method="POST" class="contents" id="form-{{ item.enrollment.id }}">
                                <input type="hidden" name="enrollment_id" value="{{ item.enrollment.id }}">
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_1" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_1 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center edit-mode-{{ item.enrollment.id }}" data-enrollment-id="{{ item.enrollment.id }}" disabled>
                                </td>
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_2" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_2 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center edit-mode-{{ item.enrollment.id }}" data-enrollment-id="{{ item.enrollment.id }}" disabled>
                                </td>
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_3" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_3 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center edit-mode-{{ item.enrollment.id }}" data-enrollment-id="{{ item.enrollment.id }}" disabled>
                                </td>
                                <td class="px-6 py-4 text-center font-bold text-lg">
                                    <span class="promedio-valor text-2xl" id="promedio-{{ item.enrollment.id }}">
                                        {% if item.total_score > 0 %}
                                            <span class="{% if item.total_score >= 60 %}text-green-600{% else %}text-red-600{% endif %}">{{ item.total_score }}</span>
                                        {% else %}
                                            <span class="text-gray-400">-</span>
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <button type="button" class="toggle-edit-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold" data-enrollment-id="{{ item.enrollment.id }}">
                                        <i class="fas fa-edit"></i> Modificar
                                    </button>
                                </td>
                            </form>
                            {% else %}
                            <td colspan="5" class="px-6 py-4">
                                <span class="text-gray-400 text-sm italic">No inscrito contigo</span>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded">
        <p class="font-semibold">No hay cursos asignados</p>
        <p class="text-sm">Solicita al administrador que te asigne cursos para registrar calificaciones.</p>
    </div>
    {% endif %}
</div>

<script>
// B√∫squeda general
const globalSearch = document.getElementById('global-search');
globalSearch.addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const allRows = document.querySelectorAll('.student-row');
    
    allRows.forEach(row => {
        const studentName = row.getAttribute('data-student-name').toLowerCase();
        if (studentName.includes(searchTerm) || searchTerm === '') {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// B√∫squeda por grado
document.querySelectorAll('.search-input').forEach(input => {
    input.addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        const gradeId = this.getAttribute('data-grade-id');
        const tbody = document.querySelector('.search-body-' + gradeId);
        const rows = tbody.querySelectorAll('.student-row');
        
        rows.forEach(row => {
            const studentName = row.getAttribute('data-student-name').toLowerCase();
            if (studentName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});

// Toggle edit mode
document.querySelectorAll('.toggle-edit-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const enrollmentId = this.getAttribute('data-enrollment-id');
        const inputs = document.querySelectorAll('.edit-mode-' + enrollmentId);
        const isDisabled = inputs[0].disabled;
        
        inputs.forEach(input => {
            input.disabled = !isDisabled;
            if (!isDisabled) {
                input.classList.add('border-yellow-500', 'border-4', 'bg-yellow-50');
            } else {
                input.classList.remove('border-yellow-500', 'border-4', 'bg-yellow-50');
            }
        });
        
        // Cambiar texto del bot√≥n
        if (isDisabled) {
            this.innerHTML = '<i class="fas fa-save"></i> Guardar';
            this.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            this.classList.add('bg-green-500', 'hover:bg-green-600');
        } else {
            this.innerHTML = '<i class="fas fa-edit"></i> Modificar';
            this.classList.remove('bg-green-500', 'hover:bg-green-600');
            this.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }
    });
});

document.querySelectorAll('.semester-input').forEach(input => {
    input.addEventListener('change', function() {
        const enrollmentId = this.getAttribute('data-enrollment-id');
        const form = document.getElementById('form-' + enrollmentId);
        
        if (form) {
            const sem1 = parseFloat(form.querySelector('input[name="semester_1"]').value) || 0;
            const sem2 = parseFloat(form.querySelector('input[name="semester_2"]').value) || 0;
            const sem3 = parseFloat(form.querySelector('input[name="semester_3"]').value) || 0;
            
            // Calcular promedio dividiendo siempre entre 3
            const promedio = Math.round(((sem1 + sem2 + sem3) / 3) * 100) / 100;
            
            // Mostrar promedio
            const promediElement = document.getElementById('promedio-' + enrollmentId);
            if (promediElement) {
                if (promedio > 0) {
                    const colorClass = promedio >= 60 ? 'text-green-600' : 'text-red-600';
                    promediElement.innerHTML = `<span class="${colorClass}">${promedio.toFixed(2)}</span>`;
                } else {
                    promediElement.innerHTML = '<span class="text-gray-400">-</span>';
                }
            }
            
            // Guardar autom√°ticamente
            const formData = new FormData(form);
            fetch('{{ url_for("teacher_grades") }}', {
                method: 'POST',
                body: formData
            }).catch(error => console.error('Error al guardar:', error));
        }
    });
});
</script>
{% endblock %}
