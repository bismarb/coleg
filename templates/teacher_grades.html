{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-4xl font-bold text-gray-800"><i class="fas fa-star text-blue-600 mr-2"></i>Registrar Calificaciones</h1>
    </div>
    
    {% if grades_data %}
        {% for grade_id, data in grades_data.items() %}
        <div class="space-y-4">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-lg">
                <h2 class="text-2xl font-bold">{{ data.grade.name }}</h2>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left">Estudiante</th>
                            <th class="px-6 py-4 text-left">Grado</th>
                            <th class="px-6 py-4 text-center">1er Semestre</th>
                            <th class="px-6 py-4 text-center">2do Semestre</th>
                            <th class="px-6 py-4 text-center">3er Semestre</th>
                            <th class="px-6 py-4 text-center">Promedio</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for item in data.students_with_scores %}
                        <tr class="hover:bg-sky-50 {% if not item.has_enrollment %}bg-gray-50{% endif %}">
                            <td class="px-6 py-4 font-semibold">{{ item.student.apellido_paterno or '' }} {{ item.student.apellido_materno or '' }} {{ item.student.user.name }}</td>
                            <td class="px-6 py-4 text-sm">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">{{ item.student.grade.name }}</span>
                            </td>
                            {% if item.has_enrollment %}
                            <form method="POST" class="contents" id="form-{{ item.enrollment.id }}">
                                <input type="hidden" name="enrollment_id" value="{{ item.enrollment.id }}">
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_1" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_1 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center" data-enrollment-id="{{ item.enrollment.id }}">
                                </td>
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_2" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_2 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center" data-enrollment-id="{{ item.enrollment.id }}">
                                </td>
                                <td class="px-6 py-4">
                                    <input type="number" name="semester_3" min="0" max="100" step="0.5" value="{{ item.enrollment.semester_3 or '' }}" placeholder="-" class="semester-input px-3 py-2 bg-sky-50 border-2 border-sky-200 rounded text-sm w-20 text-center" data-enrollment-id="{{ item.enrollment.id }}">
                                </td>
                                <td class="px-6 py-4 text-center font-bold text-lg">
                                    <span class="promedio-valor text-2xl" id="promedio-{{ item.enrollment.id }}">
                                        {% if item.total_score > 0 %}
                                            <span class="{% if item.total_score >= 60 %}text-green-600{% else %}text-red-600{% endif %}">{{ item.total_score }}</span>
                                        {% else %}
                                            <span class="text-gray-400">-</span>
                                        {% endif %}
                                    </span>
                                </td>
                            </form>
                            {% else %}
                            <td colspan="4" class="px-6 py-4">
                                <span class="text-gray-400 text-sm italic">No inscrito contigo</span>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded">
        <p class="font-semibold">No hay cursos asignados</p>
        <p class="text-sm">Solicita al administrador que te asigne cursos para registrar calificaciones.</p>
    </div>
    {% endif %}
</div>

<script>
document.querySelectorAll('.semester-input').forEach(input => {
    input.addEventListener('change', function() {
        const enrollmentId = this.getAttribute('data-enrollment-id');
        const form = document.getElementById('form-' + enrollmentId);
        
        if (form) {
            const sem1 = parseFloat(form.querySelector('input[name="semester_1"]').value) || 0;
            const sem2 = parseFloat(form.querySelector('input[name="semester_2"]').value) || 0;
            const sem3 = parseFloat(form.querySelector('input[name="semester_3"]').value) || 0;
            
            // Contar cuántos semestres tienen valores
            const valuesCount = (sem1 > 0 ? 1 : 0) + (sem2 > 0 ? 1 : 0) + (sem3 > 0 ? 1 : 0);
            
            // Calcular promedio
            let promedio = 0;
            if (valuesCount > 0) {
                promedio = (sem1 + sem2 + sem3) / valuesCount;
            }
            
            // Mostrar promedio
            const promediElement = document.getElementById('promedio-' + enrollmentId);
            if (promediElement) {
                if (promedio > 0) {
                    const colorClass = promedio >= 60 ? 'text-green-600' : 'text-red-600';
                    promediElement.innerHTML = `<span class="${colorClass}">${promedio.toFixed(2)}</span>`;
                } else {
                    promediElement.innerHTML = '<span class="text-gray-400">-</span>';
                }
            }
            
            // Guardar automáticamente
            const formData = new FormData(form);
            fetch('{{ url_for("teacher_grades") }}', {
                method: 'POST',
                body: formData
            }).catch(error => console.error('Error al guardar:', error));
        }
    });
});
</script>
{% endblock %}
